# nginx <%= @app %> php application vhost
#
# Generated by Chef for <%= node[:fqdn] %>
# Local modifications will be overwritten.
#
<% if @non_ssl_server && @www_redirect -%>
server {
<% @listen_ports.each do |port| -%>
  listen              <%= port %>;
<% end -%>
  server_name         www.<%= @host_name %>;

  rewrite ^/(.*)      http://<%= @host_name %>/$1 permanent;
}

<% end -%>
<% if @non_ssl_server -%>
server {
<% @listen_ports.each do |port| -%>
  listen              <%= port %>;
<% end -%>
  server_name         <%= @host_name %><% @host_aliases.each do |a| %><%= " #{a}" %> <% end %>;

  root                <%= @docroot %>;
  index               index.php index.html index.htm;

  if (-f $document_root/system/maintenance.html) {
    rewrite ^(.*)$ /system/maintenance.html break;
  }

  location ~ \.php$ {
    fastcgi_pass      127.0.0.1:9000;
    fastcgi_index     index.php;
    fastcgi_param     SCRIPT_FILENAME <%= @docroot %>/$fastcgi_script_name;
    fastcgi_param     PATH_INFO       $fastcgi_script_name;
    include           fastcgi_params;
  }

  error_log           <%= node[:nginx][:log_dir] %>/<%= @app %>-error.log;
  access_log          <%= node[:nginx][:log_dir] %>/<%= @app %>-access.log;
}
<% end -%>
<% if @ssl_server && @ssl_www_redirect -%>

server {
<% @ssl_listen_ports.each do |port| -%>
  listen              <%= port %>;
<% end -%>
  server_name         www.<%= @host_name %>;

  ssl                 on;
  ssl_certificate     <%= @ssl_cert %>;
  ssl_certificate_key <%= @ssl_key %>;
 
  rewrite ^/(.*)      https://<%= @host_name %>/$1 permanent;
}
<% end -%>
<% if @ssl_server -%>

server {
<% @ssl_listen_ports.each do |port| -%>
  listen              <%= port %>;
<% end -%>
  server_name         <%= @host_name %><% @host_aliases.each do |a| %><%= " #{a}" %> <% end %>;

  ssl                 on;
  ssl_certificate     <%= @ssl_cert %>;
  ssl_certificate_key <%= @ssl_key %>;
 
  root                <%= @docroot %>;
  index               index.php index.html index.htm;

  if (-f $document_root/system/maintenance.html) {
    rewrite ^(.*)$ /system/maintenance.html break;
  }

  location ~ \.php$ {
    fastcgi_pass      127.0.0.1:9000;
    fastcgi_index     index.php;
    fastcgi_param     SCRIPT_FILENAME <%= @docroot %>/$fastcgi_script_name;
    fastcgi_param     PATH_INFO       $fastcgi_script_name;
    include           fastcgi_params;
  }

  error_log           <%= node[:nginx][:log_dir] %>/<%= @app %>-error.log;
  access_log          <%= node[:nginx][:log_dir] %>/<%= @app %>-access.log;
}
<% end -%>
