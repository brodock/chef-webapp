# apache2 <%= @app %> rails application vhost
#
# Generated by Chef for <%= node[:fqdn] %>
# Local modifications will be overwritten.
#
<% if @non_ssl_server && @www_redirect && !@host_name.nil? -%>
<VirtualHost *:80>
  ServerName        www.<%= @host_name %>
<% @host_aliases.each do |a| -%>
  ServerAlias       www.<%= a %>
<% end -%>

  RewriteEngine     On
  RewriteCond       %{HTTP_HOST} ^www.<%= @host_name %>$ [NC]
  RewriteRule       ^/(.*)$ http://<%= @host_name %>/$1 [R=301,L]
</VirtualHost>

<% end -%>
<% if @non_ssl_server -%>
<VirtualHost *:80>
<% unless @host_name.nil? -%>
  ServerName        <%= @host_name %>
<% end -%>
<% @host_aliases.each do |a| -%>
  ServerAlias       <%= a %>
<% end -%>

  DocumentRoot      <%= @docroot %>
  <Directory <%= @directory_root %>>
    Options FollowSymlinks -MultiViews
    Allow from all
  </Directory>

  ErrorDocument 503 /system/maintenance.html
  RewriteEngine On
  RewriteCond %{REQUEST_URI} !\.(css|gif|jpg|png)$
  RewriteCond %{DOCUMENT_ROOT}/system/maintenance.html -f
  RewriteCond %{SCRIPT_FILENAME} !maintenance.html
  RewriteRule ^.*$  -  [redirect=503,last]
</VirtualHost>
<% end -%>
