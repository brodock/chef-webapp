# nginx <%= @app %> rails application vhost
#
# Generated by Chef for <%= node[:fqdn] %>
# Local modifications will be overwritten.
#
<% if @non_ssl_server && @www_redirect -%>
server {
<% @listen_ports.each do |port| -%>
  listen              <%= port %>;
<% end -%>
  server_name       www.<%= @host_name %>;

  rewrite ^/(.*)    http://<%= @host_name %>/$1 permanent;
}

<% end -%>
<% if @non_ssl_server -%>
server {
<% @listen_ports.each do |port| -%>
  listen              <%= port %>;
<% end -%>
  server_name         <%= @host_name %><% @host_aliases.each do |a| %><%= " #{a}" %> <% end %>;

  root                <%= @docroot %>;

  passenger_enabled on;
  rails_env           <%= @rails_env %>;

  if (-f $document_root/system/maintenance.html) {
    rewrite ^(.*)$ /system/maintenance.html break;
  }

  error_log           <%= node[:nginx][:log_dir] %>/<%= @app %>-error.log;
  access_log          <%= node[:nginx][:log_dir] %>/<%= @app %>-access.log;
}
<% end -%>
<% if @ssl_server && @ssl_www_redirect -%>

server {
<% @ssl_listen_ports.each do |port| -%>
  listen              <%= port %>;
<% end -%>
  server_name         www.<%= @host_name %>;

  ssl                 on;
  ssl_certificate     <%= @ssl_cert %>;
  ssl_certificate_key <%= @ssl_key %>;
 
  rewrite ^/(.*)      https://<%= @host_name %>/$1 permanent;
}
<% end -%>
<% if @ssl_server -%>

server {
<% @ssl_listen_ports.each do |port| -%>
  listen              <%= port %>;
<% end -%>
  server_name         <%= @host_name %><% @host_aliases.each do |a| %><%= " #{a}" %> <% end %>;

  ssl                 on;
  ssl_certificate     <%= @ssl_cert %>;
  ssl_certificate_key <%= @ssl_key %>;
 
  root                <%= @docroot %>;

  passenger_enabled on;
  rails_env           <%= @rails_env %>;

  if (-f $document_root/system/maintenance.html) {
    rewrite ^(.*)$ /system/maintenance.html break;
  }

  error_log           <%= node[:nginx][:log_dir] %>/<%= @app %>-error.log;
  access_log          <%= node[:nginx][:log_dir] %>/<%= @app %>-access.log;
}
<% end -%>
